'=======================================================================================
'Unifloc 7.24  coronav                                          khabibullin.ra@gubkin.ru
'Petroleum engineering calculations modules (macroses)
'2000 - 2019
'
'=======================================================================================
Option Explicit 'Потребовать явного объявления всех переменных в файле
'btn1 (компонент: button, атрибут: onAction), 2007
Sub btn_ribbon_version(control As IRibbonControl)
    'MsgBox "Сработала функция onAction элемента " + control.ID
    Application.StatusBar = "Сработала функция onAction элемента " + control.ID
    Call InfoForm.Show
    Application.StatusBar = ""
End Sub
'btn2 (компонент: button, атрибут: onAction), 2007
Sub btn_ribbon_links(control As IRibbonControl)
    Dim num As Integer
    addLogMsg "Сработала функция onAction элемента " + control.ID
    num = correct_links
    addLogMsg "Выполнено замен " & CStr(num)
End Sub
' решение для исправление проблемы с путями к надстройке
' https://www.planetaexcel.ru/forum/index.php?PAGE_NAME=message&FID=8&TID=10450&TITLE_SEO=10450&MID=91949#message91949
' вызывается по нажатию кнопки на риббоне
Public Function correct_links()
 Dim wb As Workbook
 Dim MyAddIn, Lnk, sh
 Dim MyAddInNameFull
 Dim aLinks
 Dim i As Integer
 i = 0
 
 On Error GoTo exit_
 
 ' определим имя надстройки
 MyAddIn = UCase(ThisWorkbook.name)
 MyAddInNameFull = ThisWorkbook.Path & "\" & ThisWorkbook.name
 Set wb = ActiveWorkbook  ' работаем с активной книгой
 With wb
   aLinks = wb.LinkSources()
   If Not IsEmpty(aLinks) Then
        For Each Lnk In .LinkSources(Type:=xlExcelLinks)
            Debug.Print Lnk
             Debug.Print UCase(Lnk), "*" & MyAddIn
          If UCase(Lnk) Like "*" & MyAddIn Then
            addLogMsg "в книге " & wb.name & " обнаружена ссылка на надстройку " & Lnk
            If UCase(Lnk) <> UCase(MyAddInNameFull) Then
                addLogMsg "в книге " & wb.name & " пытаемся исправить ссылку " & Lnk & " на корректную " & MyAddInNameFull
                .ChangeLink name:=Lnk, NewName:=MyAddIn
                i = i + 1
                For Each sh In .Worksheets
                  sh.Calculate
                Next
            Else
                addLogMsg "в книге " & wb.name & " ссылка " & Lnk & " корректная, исправления не нужны"
            End If
            'Exit For
          End If
        Next
    End If
 End With
 correct_links = i
 Exit Function
exit_:
 addLogMsg "Ошибка. В книге " & wb.name & " при исправлении ссылок на надстройку произошел сбой. что то пошло не так"
End Function
Sub test()
 Dim i As Integer
 i = 2
 Application.StatusBar = "выполнено замен " & i
End Sub

