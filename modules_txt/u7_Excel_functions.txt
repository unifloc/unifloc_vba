'=======================================================================================
'Unifloc 7.9  Vulpes zerda                                      khabibullin.ra@gubkin.ru
'Petroleum engineering calculations modules (macroses)
'2000 - 2019
'
'=======================================================================================
' базовые функции для проведения расчетов из интерфейса Excel
Option Explicit
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' функция расчета объемного коэффициента газа
Public Function PVT_bg_m3m3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' Возвращает значение объемного коэффициента газа, м3/м3
' для заданных термобарических условий.
' В основе расчета корреляция для z факотора
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_bg_m3m3 = PVT.bg_m3m3
    Exit Function
err1:
    PVT_bg_m3m3 = -1
    addLogMsg "Error:PVT_bg_m3m3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет объемного коэффициента нефти
Public Function PVT_bo_m3m3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число
' Возвращает значение объемного коэффициента нефти, м3/м3
' для заданных термобарических условий.
' В основе расчета корреляции PVT
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_bo_m3m3 = PVT.bo_m3m3
    Exit Function
err1:
    PVT_bo_m3m3 = -1
    addLogMsg "Error:PVT_bo_m3m3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет объемного коэффициента воды
Public Function PVT_bw_m3m3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число
' Возвращает значение объемного коэффициента воды, м3/м3
' для заданных термобарических условий.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_bw_m3m3 = PVT.bw_m3m3
    Exit Function
err1:
    PVT_bw_m3m3 = -1
    addLogMsg "Error:PVT_bw_m3m3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет солености воды
Public Function PVT_salinity_ppm( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число
' Возвращает соленость воды, ppm
' для заданных термобарических условий.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_salinity_ppm = PVT.sal_ppm
    Exit Function
err1:
    PVT_salinity_ppm = -1
    addLogMsg "Error:PVT_salinity_ppm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет вязкости нефти
Public Function PVT_mu_oil_cP( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - вязкость нефти
'           при заданных термобарических условиях, сП
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_mu_oil_cP = PVT.mu_oil_cP
    Exit Function
err1:
    PVT_mu_oil_cP = -1
    addLogMsg "Error:PVT_mu_oil_cP:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет вязкости газа
Public Function PVT_mu_gas_cP( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - вязкость газа
'           при заданных термобарических условиях, сП
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_mu_gas_cP = PVT.mu_gas_cP
    Exit Function
err1:
    PVT_mu_gas_cP = -1
    addLogMsg "Error:PVT_mu_gas_cP:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет вязкости воды
Public Function PVT_mu_wat_cP( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - вязкость воды
'           при заданных термобарических условиях, сП
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_mu_wat_cP = PVT.mu_wat_cP
    Exit Function
err1:
    PVT_mu_wat_cP = -1
    addLogMsg "Error:PVT_mu_wat_cP:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет газосодержания
Public Function PVT_rs_m3m3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - газосодержание при
'           заданных термобарических условиях, м3/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_rs_m3m3 = PVT.rs_m3m3
    Exit Function
err1:
    PVT_rs_m3m3 = -1
    addLogMsg "Error:PVT_Rs_m3m3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет коэффициента сверхсжимаемости газа
Public Function PVT_z( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - z фактор газа.
'           коэффициент сверхсжимаемости газа,
'           безразмерная величина
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_z = PVT.Z
    Exit Function
err1:
    PVT_z = -1
    addLogMsg "Error:PVT_Z:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет плотности нефти
Public Function PVT_rhoo_kgm3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - плотность нефти
'           при заданных термобарических условиях, кг/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_rhoo_kgm3 = PVT.rho_oil_rc_kgm3
    Exit Function
err1:
    PVT_rhoo_kgm3 = -1
    addLogMsg "Error:PVT_Rhoo_kgm3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет плотности газа
Public Function PVT_rhog_kgm3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - плотность газа
'           при заданных термобарических условиях, кг/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_rhog_kgm3 = PVT.rho_gas_rc_kgm3
    Exit Function
err1:
    PVT_rhog_kgm3 = -1
    addLogMsg "Error:PVT_Rhog_kgm3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет плотности воды
Public Function PVT_rhow_kgm3( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - плотность воды
'           при заданных термобарических условиях, кг/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_rhow_kgm3 = PVT.rho_wat_rc_kgm3
    Exit Function
err1:
    PVT_rhow_kgm3 = -1
    addLogMsg "Error:PVT_Rhow_kgm3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' Расчет давления насыщения
Public Function PVT_pb_atma( _
                 ByVal t_c As Double, _
        Optional ByVal gamma_gas As Double = const_gg_, _
        Optional ByVal gamma_oil As Double = const_go_, _
        Optional ByVal gamma_wat As Double = const_gw_, _
        Optional ByVal rsb_m3m3 = const_rsb_default, _
        Optional ByVal rp_m3m3 = -1, _
        Optional ByVal pb_atma = -1, _
        Optional ByVal tres_C = const_tres_default, _
        Optional ByVal bob_m3m3 = -1, _
        Optional ByVal muob_cP = -1, _
        Optional ByVal PVTcorr = Standing_based, _
        Optional ByVal ksep_fr = 0, _
        Optional ByVal pksep_atma = -1, _
        Optional ByVal tksep_C = -1, _
        Optional ByVal str_PVT As String = "" _
        )
' обязательные аргументы функции
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число - давление насыщения.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    PVT_pb_atma = PVT.calc_pb_atma(rsb_m3m3, t_c)
    Exit Function
err1:
    PVT_pb_atma = -1
    addLogMsg "Error:PVT_pb_atma:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет коэффициента поверхностного натяжения нефть - газ
Public Function PVT_SToilgas_Nm( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число
' Возвращает коэффициента поверхностного натяжения нефть - газ, Нм
' для заданных термобарических условий.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_SToilgas_Nm = PVT.sigma_oil_gas_Nm
    Exit Function
err1:
    PVT_SToilgas_Nm = -1
    addLogMsg "Error:PVT_SToilgas_Nm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет коэффициента поверхностного натяжения вода - газ
Public Function PVT_STwatgas_Nm( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число
' Возвращает коэффициента поверхностного натяжения вода - газ, Нм
' для заданных термобарических условий.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_STwatgas_Nm = PVT.sigma_wat_gas_Nm
    Exit Function
err1:
    PVT_STwatgas_Nm = -1
    addLogMsg "Error:PVT_STwatgas_Nm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет коэффициента поверхностного натяжения жидкость - газ
Public Function PVT_STliqgas_Nm( _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
            Optional ByVal gamma_gas As Double = const_gg_, _
            Optional ByVal gamma_oil As Double = const_go_, _
            Optional ByVal gamma_wat As Double = const_gw_, _
            Optional ByVal rsb_m3m3 = const_rsb_default, _
            Optional ByVal rp_m3m3 = -1, _
            Optional ByVal pb_atma = -1, _
            Optional ByVal tres_C = const_tres_default, _
            Optional ByVal bob_m3m3 = -1, _
            Optional ByVal muob_cP = -1, _
            Optional ByVal PVTcorr = Standing_based, _
            Optional ByVal ksep_fr = 0, _
            Optional ByVal pksep_atma = -1, _
            Optional ByVal tksep_C = -1, _
            Optional ByVal str_PVT As String = "" _
            )
' обязательные аргументы функции
' p_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gg_ = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_go_ = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gw_ = 1
' rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_rsb_default = 100
' rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед rsb если Rp < rsb
' pb_atma   Давление насыщения при  температуре tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_tres_default = 90
' bob_m3m3  объемный коэффициент нефти, м3/м3.
' muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           Standing_based = 0 - на основе кор-ии Стендинга
'           McCain_based = 1 - на основе кор-ии Маккейна
'           straigth_line = 2 - на основе упрощенных зависимостей
' ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' pksep_atma    давление при которой была сепарация
' tksep_C       температура при которой была сепарация
' str_PVT    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' результат - число
' Возвращает коэффициента поверхностного натяжения жидкость - газ, Нм
' для заданных термобарических условий.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, rp_m3m3, pb_atma, tres_C, bob_m3m3, _
                    muob_cP, PVTcorr, ksep_fr, pksep_atma, tksep_C, str_PVT)
    Call PVT.calc_PVT(p_atma, t_c)
    PVT_STliqgas_Nm = PVT.sigma_liq_Nm
    Exit Function
err1:
    PVT_STliqgas_Nm = -1
    addLogMsg "Error:PVT_STliqgas_Nm:" & Err.Description
End Function
' ===================================================================================================================
'
' ===================================================================================================================
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' функция расчета коэффициента Джоуля Томсона
Public Function MF_CJT_Katm( _
             ByVal p_atma As Double, _
             ByVal t_c As Double, _
    Optional ByVal str_PVT As String = PVT_DEFAULT, _
    Optional ByVal qliq_sm3day As Double = 10, _
    Optional ByVal fw_perc As Double = 0)
' обязательные аргументы функции
' p_atma      - давление, атм
' Т_C         - температура, С.
' опциональные аргументы функции
' str_PVT      - encoded to string PVT properties of fluid
' qliq_sm3day - liquid rate (at surface)
' fw_perc     - water fraction (watercut)
' output - number
'description_end
On Error GoTo err1:
    Dim PVT As New CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.qliq_sm3day = qliq_sm3day
    PVT.fw_perc = fw_perc
    Call PVT.calc_PVT(CDbl(p_atma), CDbl(t_c))
    MF_CJT_Katm = PVT.cJT_Katm
    Exit Function
err1:
    MF_CJT_Katm = -1
    addLogMsg "Error:MF_CJT_Katm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет объемного расхода газожидкостной смеси
' для заданных термобарических условий
Public Function MF_q_mix_rc_m3day( _
             ByVal qliq_sm3day As Double, _
             ByVal fw_perc As Double, _
             ByVal p_atma As Double, _
             ByVal t_c As Double, _
    Optional ByVal str_PVT As String = "")
' обязательные аргументы функции
' qliq_sm3day- дебит жидкости на поверхности
' fw_perc    - объемная обводненность
' p_atma     - давление, атм
' Т_C        - температура, С.
' опциональные аргументы функции
' str_PVT     - закодированная строка с параметрами PVT.
'              если задана - перекрывает другие значения
' результат  - число - плотность ГЖС, кг/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.fw_perc = fw_perc
    PVT.qliq_sm3day = qliq_sm3day
    Call PVT.calc_PVT(p_atma, t_c)
    MF_q_mix_rc_m3day = PVT.q_mix_rc_m3day
    Exit Function
err1:
    MF_q_mix_rc_m3day = -1
    addLogMsg "Error:MF_q_mix_rc_m3day:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет плотности газожидкостной смеси для заданных  условий
Public Function MF_rhomix_kgm3( _
             ByVal qliq_sm3day As Double, _
             ByVal fw_perc As Double, _
             ByVal p_atma As Double, _
             ByVal t_c As Double, _
    Optional ByVal str_PVT As String = "")
' обязательные аргументы функции
' qliq_sm3day- дебит жидкости на поверхности
' fw_perc    - объемная обводненность
' p_atma     - давление, атм
' Т_C        - температура, С.
' опциональные аргументы функции
' str_PVT     - закодированная строка с параметрами PVT.
'              если задана - перекрывает другие значения
' результат  - число - плотность ГЖС, кг/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.fw_perc = fw_perc
    PVT.qliq_sm3day = qliq_sm3day
    Call PVT.calc_PVT(CDbl(p_atma), CDbl(t_c))
    MF_rhomix_kgm3 = PVT.rho_mix_rc_kgm3
    Exit Function
err1:
    MF_rhomix_kgm3 = -1
    addLogMsg "Error:MF_Rhomix_kgm3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет вязкости газожидкостной смеси
' для заданных термобарических условий
Public Function MF_mu_mix_cP( _
            ByVal qliq_sm3day As Double, _
            ByVal fw_perc As Double, _
            ByVal p_atma As Double, _
            ByVal t_c As Double, _
   Optional ByVal str_PVT As String = "")
' обязательные аргументы функции
' qliq_sm3day - дебит жидкости на поверхности
' fw_perc     - объемная обводненность
' p_atma      - давление, атм
' Т_C         - температура, С.
' опциональные аргументы функции
' str_PVT      - закодированная строка с параметрами PVT.
'              если задана - перекрывает другие значения
' результат   - число - вязкость ГЖС, м3/сут.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.fw_perc = fw_perc
    PVT.qliq_sm3day = qliq_sm3day
    Call PVT.calc_PVT(CDbl(p_atma), CDbl(t_c))
    MF_mu_mix_cP = PVT.mu_mix_cP
    Exit Function
err1:
    MF_mu_mix_cP = -1
    addLogMsg "Error:MF_mu_mix_cP:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет доли газа в потоке
Public Function MF_gas_fraction_d( _
              ByVal p_atma As Double, _
              ByVal t_c As Double, _
     Optional ByVal fw_perc = 0, _
     Optional ByVal str_PVT As String = PVT_DEFAULT _
                                 )
' обязательные аргументы функции
' p_atma   - давление, атм
' Т_C      - температура, С.
' опциональные аргументы функции
' fw_perc  - обводненность объемная
' str_PVT   - закодированная строка с параметрами PVT.
'            если задана - перекрывает другие значения
' результат - число - доля газа в потоке
'              (расходная без проскальзования)
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.fw_perc = fw_perc
    Call PVT.calc_PVT(CDbl(p_atma), CDbl(t_c))
    MF_gas_fraction_d = PVT.gas_fraction_d(0)
    Exit Function
err1:
    MF_gas_fraction_d = -1
    addLogMsg "Error:MF_gas_fraction_d:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет давления при котором
' достигается заданная доля газа в потоке
Public Function MF_p_gas_fraction_atma( _
               ByVal FreeGas_d As Double, _
               ByVal t_c As Double, _
               ByVal fw_perc As Double, _
      Optional ByVal str_PVT As String = PVT_DEFAULT)
' обязательные аргументы функции
' FreeGas_d - допустимая доля газа в потоке;
' Т_C       - температура, С;
' fw_perc   - объемная обводненность, проценты %;
' опциональные аргументы функции
' str_PVT    - закодированная строка с параметрами PVT.
'             Если задана - перекрывает другие значения.
' результат - число - давление, атма.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.fw_perc = fw_perc
    MF_p_gas_fraction_atma = PVT.p_gas_fraction_atma(FreeGas_d, t_c)
    Exit Function
err1:
    MF_p_gas_fraction_atma = -1
    addLogMsg "Error:MF_p_gas_fraction_atma:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет газового фактора
' при котором достигается заданная доля газа в потоке
Public Function MF_rp_gas_fraction_m3m3( _
                ByVal FreeGas_d As Double, _
                ByVal p_atma As Double, _
                ByVal t_c As Double, _
                ByVal fw_perc As Double, _
       Optional ByVal str_PVT As String = PVT_DEFAULT)
' обязательные аргументы функции
' FreeGas_d  - допустимая доля газа в потоке
' p_atma     - давление, атм
' Т_C        - температура, С.
' fw_perc   - объемная обводненность, проценты %;
' опциональные аргументы функции
' str_PVT     - закодированная строка с параметрами PVT.
'              если задана - перекрывает другие значения
' результат  - число - газовый фактор, м3/м3.
'description_end
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_decode_string(str_PVT)
    PVT.fw_perc = fw_perc
    MF_rp_gas_fraction_m3m3 = PVT.rp_gas_fraction_m3m3(FreeGas_d, p_atma, t_c)
    Exit Function
err1:
    MF_rp_gas_fraction_m3m3 = -1
    addLogMsg "Error:MF_rp_gas_fraction_m3m3:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет натуральной сепарации газа на приеме насоса
Public Function MF_ksep_natural_d( _
             ByVal qliq_sm3day As Double, _
             ByVal fw_perc As Double, _
             ByVal p_intake_atma As Double, _
    Optional ByVal t_intake_C As Double = 50, _
    Optional ByVal d_intake_mm As Double = 90, _
    Optional ByVal d_cas_mm As Double = 120, _
    Optional ByVal str_PVT As String = PVT_DEFAULT)
'----------------------------------------------------------------
' qliq_sm3day   - дебит жидкости в поверхностных условиях
' fw_perc       - обводненность
' p_intake_atma      - давление сепарации
' t_intake_C         - температура сепарации
' d_intake_mm    - диаметр приемной сетки
' d_cas_mm       - диаметр эксплуатационной колонны
' str_PVT    - закодированная строка с параметрами PVT.
'             если задана - перекрывает другие значения
' результат     - число - естественная сепарация
'description_end
On Error GoTo err1:
    Dim fluid As New CPVT
    Set fluid = PVT_decode_string(str_PVT)
    fluid.qliq_sm3day = qliq_sm3day
    fluid.fw_perc = fw_perc
    Call fluid.calc_PVT(p_intake_atma, t_intake_C)
    With fluid
        MF_ksep_natural_d = unf_calc_natural_separation(d_intake_mm / 1000, d_cas_mm / 1000, .qliq_sm3day, .q_gas_sm3day, .bo_m3m3, .bg_m3m3, .sigma_oil_gas_Nm, .rho_oil_sckgm3, .rho_gas_sckgm3, .fw_perc)
    End With
    Exit Function
err1:
    MF_ksep_natural_d = -1
    addLogMsg "Error:MF_ksep_natural_d:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет общей сепарации на приеме насоса
Public Function MF_ksep_total_d( _
        ByVal SepNat As Double, _
        ByVal SepGasSep As Double)
' SepNat        - естественная сепарация
' SepGasSep     - искусственная сепарация (газосепаратор)
    MF_ksep_total_d = SepNat + (1 - SepNat) * SepGasSep
End Function
'description_end
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет коэффициента сепарации газосепаратора
' по результатам стендовых испытаний РГУ нефти и газа
Public Function MF_ksep_gasseparator_d( _
                ByVal gsep_type_TYPE As Integer, _
                ByVal gas_frac_d As Double, _
                ByVal qliq_sm3day As Double, _
       Optional ByVal freq_Hz As Double = 50) As Double
' MY_SEPFACTOR - Вычисление коэффициента сепрации в точке
'   gsep_type_TYPE    - тип сепаратора (номер от 1 до 29)
'    1  - 'GDNK5'
'    2  - 'VGSA (VORTEX)'
'    3  - 'GDNK5A'
'    4  - 'GSA5-1'
'    5  - 'GSA5-3'
'    6  - 'GSA5-4'
'    7  - 'GSAN-5A'
'    8  - 'GSD-5A'
'    9  - 'GSD5'
'    10 - '3MNGB5'
'    11 - '3MNGB5A'
'    12 - '3MNGDB5'
'    13 - '3MNGDB5A'
'    14 - 'MNGSL5A-M'
'    15 - 'MNGSL5A-TM'
'    16 - 'MNGSL5-M'
'    17 - 'MNGSL5-TM'
'    18 - 'MNGSLM 5'
'    19 - 'MNGD 5'
'    20 - 'GSIK 5A'
'    21 - '338DSR'
'    22 - '400GSR'
'    23 - '400GSV'
'    24 - '400GSVHV'
'    25 - '538 GSR'
'    26 - '538 GSVHV'
'    27 - '400FSR(OLD)'
'    28 - '513GRS(OLD)'
'    29 - '675HRS'
'
'   gas_frac_d       - газосодержание на входе в газосепаратор
'   qliq_sm3day      - дебит жидкости в стандартных условиях
'   freq_Hz          - частота врашения, Гц
'description_end
    MF_ksep_gasseparator_d = my_sepfactor(gsep_type_TYPE, gas_frac_d * 100, qliq_sm3day, freq_Hz * 60) / 100
    
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' название газосопаратора
Public Function MF_gasseparator_name( _
                ByVal gsep_type_TYPE As Integer)
' MY_SEPFACTOR - Вычисление коэффициента сепрации в точке
'   gsep_type_TYPE    - тип сепаратора (номер от 1 до 29)
'    1  - 'GDNK5'
'    2  - 'VGSA (VORTEX)'
'    3  - 'GDNK5A'
'    4  - 'GSA5-1'
'    5  - 'GSA5-3'
'    6  - 'GSA5-4'
'    7  - 'GSAN-5A'
'    8  - 'GSD-5A'
'    9  - 'GSD5'
'    10 - '3MNGB5'
'    11 - '3MNGB5A'
'    12 - '3MNGDB5'
'    13 - '3MNGDB5A'
'    14 - 'MNGSL5A-M'
'    15 - 'MNGSL5A-TM'
'    16 - 'MNGSL5-M'
'    17 - 'MNGSL5-TM'
'    18 - 'MNGSLM 5'
'    19 - 'MNGD 5'
'    20 - 'GSIK 5A'
'    21 - '338DSR'
'    22 - '400GSR'
'    23 - '400GSV'
'    24 - '400GSVHV'
'    25 - '538 GSR'
'    26 - '538 GSVHV'
'    27 - '400FSR(OLD)'
'    28 - '513GRS(OLD)'
'    29 - '675HRS'
'description_end
    MF_gasseparator_name = Separator_Name(gsep_type_TYPE)
    
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
'расчет градиента давления
'с использованием многофазных корреляций
Public Function MF_dpdl_atmm(ByVal d_m As Double, _
             ByVal p_atma As Double, _
             ByVal Ql_rc_m3day As Double, _
             ByVal Qg_rc_m3day As Double, _
    Optional ByVal mu_oil_cP As Double = const_mu_o, _
    Optional ByVal mu_gas_cP As Double = const_mu_g, _
    Optional ByVal sigma_oil_gas_Nm As Double = const_sigma_oil_Nm, _
    Optional ByVal gamma_oil As Double = const_go_, _
    Optional ByVal gamma_gas As Double = const_gg_, _
    Optional ByVal eps_m As Double = 0.0001, _
    Optional ByVal theta_deg As Double = 90, _
    Optional ByVal ZNLF As Boolean = False)
' расчет градиента давления по одной из корреляций
' объемные коэффициенты по умолчанию
' заданы равными единицам - если их не трогать,
' значит дебиты в рабочих условиях
' газосодержание равно нулю по умолчанию
'  - значит весь газ который указан идет в потоке
' пока только для Ансари - потом можно
' распространить и на другие методы
' d_m - диаметр трубы в которой идет поток
' p_atma - давление в точке расчета
' Ql_rc_m3day - дебит жидкости в рабочих условиях
' Qg_rc_m3day - дебит газа в рабочих условиях
' mu_oil_cP - вязкость нефти в рабочих условиях
' mu_gas_cP - вязкость газа в рабочих условиях
' sigma_oil_gas_Nm - поверхностное натяжение
'              жидкость газ
' gamma_oil - удельная плотность нефти
' gamma_gas - удельная плотность газа
' eps_m    - шероховатость
' theta_deg - угол от горизонтали
' ZNLF  - флаг для расчета барботажа
'description_end
    Dim rho_osc_kgm3 As Double
    Dim rho_gsc_kgm3 As Double
    Dim dPdLg_out_atmm As Double
    Dim dPdLf_out_atmm As Double
    Dim Vsl_out_msec As Double
    Dim Vsg_out_msec As Double
    Dim Hl_out_fr As Double
    Dim fpat_out_num
    Dim dPdLa_out_atmm As Double
    Dim PrGrad
    
On Error GoTo er1:
    rho_osc_kgm3 = gamma_oil * const_rho_ref
    rho_gsc_kgm3 = gamma_gas * const_rho_air
    PrGrad = unf_AnsariGradient(d_m, theta_deg, eps_m, _
                                Ql_rc_m3day, Qg_rc_m3day, _
                                mu_oil_cP, mu_gas_cP, _
                                sigma_oil_gas_Nm, _
                                rho_osc_kgm3, _
                                rho_gsc_kgm3, _
                                p_atma)
    MF_dpdl_atmm = PrGrad
    Exit Function
er1:
    MF_dpdl_atmm = -1
    addLogMsg "Error:MF_dpdl_atmm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
'  расчет перепада давления и распределения температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_dp_pipe_atm( _
        ByVal qliq_sm3day As Double, _
        ByVal fw_perc As Double, _
        ByVal length_m As Double, _
        ByVal pcalc_atma As Double, _
        ByVal calc_along_flow As Boolean, _
        Optional ByVal str_PVT As String = PVT_DEFAULT, _
        Optional ByVal theta_deg As Double = 90, _
        Optional ByVal d_mm As Double = 60, _
        Optional ByVal hydr_corr As H_CORRELATION = 0, _
        Optional ByVal tcalc_C As Double = 50, _
        Optional ByVal tother_C As Double = -1, _
        Optional ByVal c_calibr_grav = 1, _
        Optional ByVal c_calibr_fric = 1, _
        Optional ByVal roughness_m As Double = 0.0001)
' Обязательные параметры
' qliq_sm3day - дебит жидкости в поверхностных условиях
' fw_perc     - обводненность
' length_m    - Длина трубы, измеренная, м
' calc_along_flow - флаг направления расчета относительно потока
'     если = True то расчет по потоку
'     если = False то расчет против потока
' pcalc_atma  - давление с которого начинается расчет, атм
'               граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' str_PVT      - закодированная строка с параметрами PVT.
'               если задана - перекрывает другие значения
' theta_deg   - угол направления потока к горизонтали
'               (90 - вертикальная труба поток вверх
'                -90 - вертикальная труба поток вниз)
'               может принимать отрицательные значения
' d_mm        - внутрнний диаметр трубы
' hydr_corr    - гидравлическая корреляция, H_CORRELATION
'                  BeggsBrill = 0
'                  Ansari = 1
'                  Unified = 2
'                  Gray = 3
'                  HagedornBrown = 4
'                  SakharovMokhov = 5
' Tcalc_C     - температура в точке где задано давление, С
' Tother_C    - температура на другом конце трубы
'               по умолчанию температура вдоль трубы постоянна
'               если задано то меняется линейно по трубе
' c_calibr_grav  - поправка на гравитационную составляющую
'               перепада давления
' c_calibr_fric  - поправка на трение в перепаде давления
' roughness_m - шероховатость трубы
' результат   - число - давление на другом конце трубы atma.
'description_end
On Error GoTo err1:
    Dim dPT(2) As Double
    Dim pt
    pt = MF_p_pipe_atma(qliq_sm3day, fw_perc, _
                length_m, _
                pcalc_atma, _
                calc_along_flow, _
                str_PVT, _
                theta_deg, _
                d_mm, _
                hydr_corr, _
                tcalc_C, tother_C, _
                c_calibr_grav, c_calibr_fric, _
                roughness_m)
    If Not calc_along_flow Then
        dPT(0) = pt(0) - pcalc_atma
        dPT(1) = pt(1) - tcalc_C
    Else
        dPT(0) = pcalc_atma - pt(0)
        dPT(1) = tcalc_C - pt(1)
    End If
    MF_dp_pipe_atm = dPT
    Exit Function
err1:
    MF_dp_pipe_atm = -1
    addLogMsg "Error:MF_dp_pipe_atm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
'  подбор параметров потока через трубу при известном
'  перепаде давления с использованием многофазных корреляций
Public Function MF_calibr_pipe_m3day( _
        ByVal qliq_sm3day As Double, _
        ByVal fw_perc As Double, _
        ByVal length_m As Double, _
        ByVal pin_atma As Double, _
        ByVal pout_atma As Double, _
        Optional ByVal str_PVT As String = PVT_DEFAULT, _
        Optional ByVal theta_deg As Double = 90, _
        Optional ByVal d_mm As Double = 60, _
        Optional ByVal hydr_corr As H_CORRELATION = 0, _
        Optional ByVal Tin_C As Double = 50, _
        Optional ByVal Tout_C As Double = -1, _
        Optional ByVal c_calibr_grav = 1, _
        Optional ByVal c_calibr_fric = 1, _
        Optional ByVal roughness_m As Double = 0.0001, _
        Optional ByVal calibr_type As Integer = 0)
' Обязательные параметры
' qliq_sm3day - дебит жидкости в поверхностных условиях
' fw_perc     - обводненность
' Length_m    - Длина трубы, измеренная, м
' pin_atma    - давление на входе потока в трубу, атм
'               граничное значение для проведения расчета
' pout_atma   - давление на выходе потока из трубы, атм
'               граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' str_PVT      - закодированная строка с параметрами PVT.
'               если задана - перекрывает другие значения
' theta_deg   - угол направления потока к горизонтали
'               (90 - вертикальная труба поток вверх
'                -90 - вертикальная труба поток вниз)
'               может принимать отрицательные значения
' d_mm        - внутрнний диаметр трубы
' hydr_corr    - гидравлическая корреляция, H_CORRELATION
'                  BeggsBrill = 0
'                  Ansari = 1
'                  Unified = 2
'                  Gray = 3
'                  HagedornBrown = 4
'                  SakharovMokhov = 5
' tin_C       - температура на входе потока в трубу, С
' tout_C      - температура на выходе потока из трубы, С
'               по умолчанию температура вдоль трубы постоянна
'               если задано то меняется линейно по трубе
' c_calibr_grav  - поправка на гравитационную составляющую
'               перепада давления
' c_calibr_fric  - поправка на трение в перепаде давления
' roughness_m - шероховатость трубы
' calibr_type - тип калибровки
'             0 - подбор параметра c_calibr_grav
'             1 - подбор параметра c_calibr_fric
'             2 - подбор обводненности
'             3 - подбор газового фактор
' результат   - число - давление на другом конце трубы atma.
'description_end
    
    
    Dim pipe As New CPipe
    Dim PTin As PTtype, PTout As PTtype
    Dim TM As TEMP_CALC_METHOD
    Dim prm As New CSolveParam
    Dim CoeffA(0 To 2)
On Error GoTo err1:
    ' length must be positive
    length_m = Abs(length_m)
    ' check trivial initial data
    If length_m = 0 Then
        MF_calibr_pipe_m3day = "error. length_m = 0"
        Exit Function
    End If
    ' initialize PVT properties
    Set pipe.fluid = PVT_decode_string(str_PVT)
    With pipe.fluid
    ' set liquid rate and watercut
        .qliq_sm3day = qliq_sm3day
        .fw_perc = fw_perc
    End With
    ' initialize boundary conditions
    If Tout_C < 0 Then Tout_C = Tin_C
'    ' initialize geometry
    Call pipe.InitPipe(d_mm / 1000, length_m, theta_deg, roughness_m)
    With pipe
        .param = param_calc_along_flow(hydr_corr, TempMeth:=StartEndTemp)
        .InitTlinear Tin_C, Tout_C
        .c_calibr_grav = c_calibr_grav
    End With
    ' prepare solution function
    Set CoeffA(0) = pipe
        CoeffA(1) = pin_atma
        CoeffA(2) = pout_atma
    Dim func As String
    Dim val_min As Double, val_max As Double
    Select Case calibr_type
        Case 0
            func = "calc_pipe_dp_error_calibr_grav_atm"
            val_min = 0.5
            val_max = 1.5
        Case 1
            func = "calc_pipe_dp_error_calibr_fric_atm"
            val_min = 0.5
            val_max = 1.5
        Case 2
            func = "calc_pipe_dp_error_rp_atm"
            val_min = pipe.fluid.rp_m3m3 * 0.5
            val_max = pipe.fluid.rp_m3m3 * 2
        Case 3
            func = "calc_pipe_dp_error_fw_atm"
            val_min = pipe.fluid.fw_fr * 0.5
            val_max = pipe.fluid.fw_fr * 2
            If val_max > 1 Then val_max = 1
    End Select
    If solve_equation_bisection(func, val_min, val_max, CoeffA, prm) Then
        MF_calibr_pipe_m3day = Array(prm.x_solution, _
                                     prm.y_solution, _
                                     prm.iterations, _
                                     prm.msg)
        
    Else
       MF_calibr_pipe_m3day = Array("no solution", _
                                    prm.y_solution, _
                                    prm.iterations, _
                                    prm.msg)
    End If
    
    Exit Function
err1:
    MF_calibr_pipe_m3day = Array(-1, "error")
    addLogMsg "Error:MF_calibr_pipe_m3day:" & Err.Description
    
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
'  расчет распределения давления и температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_p_pipe_atma( _
        ByVal qliq_sm3day As Double, _
        ByVal fw_perc As Double, _
        ByVal length_m As Double, _
        ByVal pcalc_atma As Double, _
        ByVal calc_along_flow As Boolean, _
        Optional ByVal str_PVT As String = PVT_DEFAULT, _
        Optional ByVal theta_deg As Double = 90, _
        Optional ByVal d_mm As Double = 60, _
        Optional ByVal hydr_corr As H_CORRELATION = 0, _
        Optional ByVal tcalc_C As Double = 50, _
        Optional ByVal tother_C As Double = -1, _
        Optional ByVal c_calibr_grav = 1, _
        Optional ByVal c_calibr_fric = 1, _
        Optional ByVal roughness_m As Double = 0.0001)
' Обязательные параметры
' qliq_sm3day - дебит жидкости в поверхностных условиях
' fw_perc     - обводненность
' Length_m    - Длина трубы, измеренная, м
' calc_along_flow - флаг направления расчета относительно потока
'     если = True то расчет по потоку
'     если = False то расчет против потока
' Pcalc_atma  - давление с которого начинается расчет, атм
'               граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' str_PVT      - закодированная строка с параметрами PVT.
'               если задана - перекрывает другие значения
' theta_deg   - угол направления потока к горизонтали
'               (90 - вертикальная труба поток вверх
'                -90 - вертикальная труба поток вниз)
'               может принимать отрицательные значения
' d_mm        - внутрнний диаметр трубы
' hydr_corr    - гидравлическая корреляция, H_CORRELATION
'                  BeggsBrill = 0
'                  Ansari = 1
'                  Unified = 2
'                  Gray = 3
'                  HagedornBrown = 4
'                  SakharovMokhov = 5
' Tcalc_C     - температура в точке где задано давление, С
' Tother_C    - температура на другом конце трубы
'               по умолчанию температура вдоль трубы постоянна
'               если задано то меняется линейно по трубе
' c_calibr_grav  - поправка на гравитационную составляющую
'               перепада давления
' c_calibr_fric  - поправка на трение в перепаде давления
' roughness_m - шероховатость трубы
' результат   - число - давление на другом конце трубы atma.
'description_end
    Dim pipe As New CPipe
    Dim PVT As New CPVT
    Dim PTcalc As PTtype
    Dim TM As TEMP_CALC_METHOD
On Error GoTo err1:
    ' length must be positive
    length_m = Abs(length_m)
    ' check trivial initial data
    If length_m = 0 Then
        MF_p_pipe_atma = Array(pcalc_atma, tcalc_C)
        Exit Function
    End If
    ' initialize PVT properties
    Set PVT = PVT_decode_string(str_PVT)
    ' set liquid rate and watercut
    PVT.qliq_sm3day = qliq_sm3day
    PVT.fw_perc = fw_perc
    Set pipe.fluid = PVT
    ' initialize boundary conditions
 '   PTcalc.p_atma = pcalc_atma
 '   PTcalc.t_c = tcalc_C
    If tother_C < 0 Then tother_C = tcalc_C
    ' initialize geometry
    Call pipe.InitPipe(d_mm / 1000, length_m, theta_deg, roughness_m)
    ' check flow direction
    ' Pcalc and Tcalc position depends on calc_along_flow
    ' because coord system always goes along flow
    If calc_along_flow Then
        pipe.param = param_calc_along_flow(hydr_corr, TempMeth:=StartEndTemp)
        pipe.InitTlinear tother_C, tcalc_C
    Else
        pipe.param = param_calc_against_flow(hydr_corr, TempMeth:=StartEndTemp)
        pipe.InitTlinear tcalc_C, tother_C
    End If
    ' set calibration properties
    pipe.c_calibr_grav = c_calibr_grav
    pipe.c_calibr_fric = c_calibr_fric
    ' calc pressure distribution
    MF_p_pipe_atma = ArrayOut(pipe.calc_dPipe(pcalc_atma, noCurves))
    Exit Function
err1:
    MF_p_pipe_atma = Array(-1, "error")
    addLogMsg "Error:MF_p_pipe_atma:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
'  расчет давления и распределения температуры в трубе
'  при барботаже (движение газа в затрубе при неподвижной жидкости)
'  с использованием многофазных корреляций
Public Function MF_p_pipe_znlf_atma( _
        ByVal qliq_sm3day As Double, _
        ByVal fw_perc As Double, _
        ByVal length_m As Double, _
        ByVal pcalc_atma As Double, _
        ByVal calc_along_flow As Boolean, _
        Optional ByVal str_PVT As String = PVT_DEFAULT, _
        Optional ByVal theta_deg As Double = 90, _
        Optional ByVal d_mm As Double = 60, _
        Optional ByVal hydr_corr As H_CORRELATION = 0, _
        Optional ByVal tcalc_C As Double = 50, _
        Optional ByVal tother_C As Double = -1, _
        Optional ByVal c_calibr_grav = 1, _
        Optional ByVal c_calibr_fric = 1, _
        Optional ByVal roughness_m As Double = 0.0001, _
        Optional ByVal Qgcas_free_scm3day As Double = 50)
' Обязательные параметры
' qliq_sm3day    - дебит жидкости в поверхностных условиях
'                 (учтется при расчете газа в затрубе)
' fw_perc    - обводненность
' Length_m    - Длина трубы, измеренная, м
' calc_along_flow - флаг направления расчета относительно потока
'     если = True то расчет по потоку
'     если = False то расчет против потока
' Pcalc_atma  - давление с которого начинается расчет, атм
'               граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' str_PVT     - закодированная строка с параметрами PVT.
'              если задана - перекрывает другие значения
' theta_deg  - угол направления потока к горизонтали
'              (90 - вертикальная труба вверх)
'              может принимать отрицательные значения
' d_mm       - внутрнний диаметр трубы
' hydr_corr   - гидравлическая корреляция, H_CORRELATION
'                   BeggsBrill = 0
'                   Ansari = 1
'                   Unified = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
'               для барботажа принудительно на основе Ансари пока
' Tcalc_C    - температура в точке где задано давление, С
' Tother_C   - температура на другом конце трубы
'              по умолчанию температура вдоль трубы постоянна
'              если задано то меняется линейно по трубе
' c_calibr_grav - поправка на гравитационную составляющую
'              перепада давления
' c_calibr_fric - поправка на трение в перепаде давления
' roughness_m  - шероховатость трубы
' Qgcas_free_scm3day    - количество газа в затрубе
' результат  - число - давление на другом конце трубы atma.
'description_end
    Dim pipe As New CPipe
    Dim PVT As New CPVT
    Dim PTcalc As PTtype
    Dim TM As TEMP_CALC_METHOD
    Dim Qg_free_scm3day As Double
On Error GoTo err1:
    ' length must be positive
    length_m = Abs(length_m)
    ' check direction
    If theta_deg <= 0 Then
        ' gas can not flow downward or horisontally
        GoTo err2:
    End If
    ' check trivial initial data
    If length_m = 0 Then
        MF_p_pipe_znlf_atma = Array(pcalc_atma, tcalc_C)
        Exit Function
    End If
    ' initialize PVT properties
    Set PVT = PVT_decode_string(str_PVT)
    PVT.qliq_sm3day = qliq_sm3day
    PVT.fw_perc = fw_perc
    
    PVT.q_gas_free_sm3day = Qgcas_free_scm3day  ' оставляем газ только в затрубе который
    Set pipe.fluid = PVT
    ' initialize boundary conditions
    PTcalc.p_atma = pcalc_atma
    PTcalc.t_c = tcalc_C
    If tother_C < 0 Then tother_C = tcalc_C
    ' initialize geometry
    Call pipe.InitPipe(d_mm / 1000, length_m, theta_deg, roughness_m)
    ' check flow direction
    ' Pcalc and Tcalc position depends on calc_along_flow
    ' because coord system always goes along flow
    If calc_along_flow Then
        pipe.param = param_calc_along_flow(hydr_corr, TempMeth:=StartEndTemp)
        pipe.InitTlinear tcalc_C, tother_C
    Else
        pipe.param = param_calc_against_flow(hydr_corr, TempMeth:=StartEndTemp)
        pipe.InitTlinear tother_C, tcalc_C
    End If
    pipe.c_calibr_grav = c_calibr_grav
    pipe.c_calibr_fric = c_calibr_fric
    ' calc pressure distribution
    MF_p_pipe_znlf_atma = ArrayOut(pipe.calc_dPipeZNLF(PTcalc, noCurves))
    
    Exit Function
err1:
    MF_p_pipe_znlf_atma = Array(-1, "error")
    addLogMsg "Error:MF_p_pipe_znlf_atma:" & Err.Description
    Exit Function
err2:
    MF_p_pipe_znlf_atma = Array(-1, "error")
    addLogMsg "Error:MF_p_pipe_znlf_atma: gas can not flow downward or horizontally" & theta_deg
    
End Function
' ==============  функции для расчета штуцера ==========================
' =====================================================================
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' Расчет перепада давления в штуцере (по потоку)
Public Function MF_dp_choke_atm( _
            ByVal qliq_sm3day As Double, _
            ByVal fw_perc As Double, _
            ByVal dchoke_mm As Double, _
            Optional ByVal pcalc_atma As Double = -1, _
            Optional ByVal calc_along_flow As Boolean = True, _
            Optional ByVal d_pipe_mm As Double = 70, _
            Optional ByVal tchoke_C As Double = 20, _
            Optional ByVal c_calibr_fr As Double = 1, _
            Optional ByVal str_PVT As String = PVT_DEFAULT _
            )
' qliq_sm3day    - дебит жидкости в пов условиях
' fw_perc       - обводненность
' dchoke_mm     - диаметр штуцера (эффективный)
' опциональные аргументы функции
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
'                 либо давление на входе, либое на выходе
'calc_along_flow - флаг направления расчета относительно потока
'     если = True то расчет по потоку
'     ищется давление на выкиде по известному давлению на входе,
'     ищется линейное давление по известному буферному
'     если = False то расчет против потока
'     ищется давление на входе по известному давлению на выходе,
'     ищется буферное давление по известному линейному
' d_pipe_mm    - диаметр трубы до и после штуцера
' Tchoke_C    - температура, С.
' c_calibr_fr     - поправочный коэффициент на штуцер
'                 1 - отсутсвие поправки
'                 Q_choke_real = c_calibr_fr * Q_choke_model
' str_PVT      - закодированная строка с параметрами PVT.
'               если задана - перекрывает другие значения
' результат   - число - давления на штуцере на расчетной стороне.
'             двухмерный массив с расширенным наборов параметров
'               и подписей к параметрам
'description_end
On Error GoTo err1:
    Dim pt
    Dim p_intake_atma As Double
    Dim p_out_atma As Double
    
    pt = MF_p_choke_atma( _
            qliq_sm3day, fw_perc, _
            dchoke_mm, _
            pcalc_atma, _
            calc_along_flow, _
            d_pipe_mm, _
            tchoke_C, _
            c_calibr_fr, _
            str_PVT)
            
    p_out_atma = pt(0)(2)
    p_intake_atma = pt(0)(1)
    c_calibr_fr = pt(0)(4)
    
    MF_dp_choke_atm = Array(Array(p_intake_atma - p_out_atma, tchoke_C, c_calibr_fr), _
                           Array("dP_atm", "Tchoke_C", "c_calibr_fr"))
    
    Exit Function
err1:
    MF_dp_choke_atm = -1
    addLogMsg "Error:MF_dp_choke_atm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет давления в штуцере
Public Function MF_p_choke_atma( _
            ByVal qliq_sm3day As Double, _
            ByVal fw_perc As Double, _
            ByVal dchoke_mm As Double, _
            Optional ByVal pcalc_atma As Double = -1, _
            Optional ByVal calc_along_flow As Boolean = True, _
            Optional ByVal d_pipe_mm As Double = 70, _
            Optional ByVal tchoke_C As Double = 20, _
            Optional ByVal c_calibr_fr As Double = 1, _
            Optional ByVal str_PVT As String = PVT_DEFAULT _
            )
'@qliq_sm3day   - дебит жидкости в поверхностных условиях
'@fw_perc       - обводненность
'@dchoke_mm     - диаметр штуцера (эффективный)
''опциональные аргументы функции
'@pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
'                 либо давление на входе, либое на выходе
'@calc_along_flow - флаг направления расчета относительно потока
'     если = True то расчет по потоку
'     ищется давление на выкиде по известному давлению на входе,
'     ищется линейное давление по известному буферному
'     если = False то расчет против потока
'     ищется давление на входе по известному давлению на выходе,
'     ищется буферное давление по известному линейному
'@d_pipe_mm      - диаметр трубы до и после штуцера
'@tchoke_C      - температура, С.
'@c_calibr_fr   - поправочный коэффициент на штуцер
'                 1 - отсутсвие поправки
'                 Q_choke_real = c_calibr_fr * Q_choke_model
'@str_PVT        - закодированная строка с параметрами PVT.
'                 если задана - перекрывает другие значения
''результат     - число - давления на штуцере на расчетной стороне.
''                массив значений с параметрами штуцера
'description_end
On Error GoTo err1:
    Dim choke As New Cchoke
    Dim pt As PTtype
    Dim PVT As CPVT
    Dim out, out_desc
    Dim p_in_atma As Double
    Dim p_out_atma As Double
    
    
    Set PVT = PVT_decode_string(str_PVT)
    Set choke.fluid = PVT
    choke.fluid.qliq_sm3day = qliq_sm3day
    choke.fluid.fw_perc = fw_perc
    choke.Ddown_m = d_pipe_mm / 1000
    choke.Dup_m = d_pipe_mm / 1000
    choke.Dchoke_m = dchoke_mm / 1000
    choke.c_calibr_fr = c_calibr_fr
    
    If calc_along_flow Then
        p_in_atma = pcalc_atma
        pt = choke.calc_choke_plin(SetPT(p_in_atma, tchoke_C))
        out = pt.p_atma
        p_out_atma = out
        out_desc = "Pout, atma"
    Else
        p_out_atma = pcalc_atma
        pt = choke.calc_choke_pbuf(SetPT(p_out_atma, tchoke_C))
        out = pt.p_atma
        p_in_atma = out
        out_desc = "Pin, atma"
    End If
    MF_p_choke_atma = Array(Array(out, p_in_atma, p_out_atma, tchoke_C, choke.c_calibr_fr), _
                           Array(out_desc, "p_intake_atma", "p_out_atma", "Tchoke_C", "c_calibr_fr"))  ' на выходе выдаем массив
    Exit Function
err1:
    MF_p_choke_atma = -1
    addLogMsg "Error:MF_PChoke_atm:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет корректирующего фактора (множителя) модели штуцера под замеры
Public Function MF_calibr_choke_fr( _
            ByVal qliq_sm3day As Double, _
            ByVal fw_perc As Double, _
            ByVal dchoke_mm As Double, _
            Optional ByVal p_in_atma As Double = -1, _
            Optional ByVal p_out_atma As Double = -1, _
            Optional ByVal d_pipe_mm As Double = 70, _
            Optional ByVal tchoke_C As Double = 20, _
            Optional ByVal str_PVT As String = PVT_DEFAULT _
            )
' qliq_sm3day    - дебит жидкости в пов условиях
' fw_perc       - обводненность
' dchoke_mm     - диаметр штуцера (эффективный)
' опциональные аргументы функции
' p_in_atma      - давление на входе (высокой стороне)
' p_out_atma     - давление на выходе (низкой стороне)
' d_pipe_mm      - диаметр трубы до и после штуцера
' Tchoke_C      - температура, С.
' str_PVT        - закодированная строка с параметрами PVT.
'                 если задана - перекрывает другие значения
' результат     - число - калибровочный коэффициент для модели.
'                 штуцера  - множитель на дебит через штуцер
'description_end
On Error GoTo err1:
    Dim choke As New Cchoke
    Dim pt As PTtype
    Dim PVT As CPVT
    Dim out, out_desc
    
    Set PVT = PVT_decode_string(str_PVT)
    Set choke.fluid = PVT
    choke.fluid.qliq_sm3day = qliq_sm3day
    choke.fluid.fw_perc = fw_perc
    choke.Ddown_m = d_pipe_mm / 1000
    choke.Dup_m = d_pipe_mm / 1000
    choke.Dchoke_m = dchoke_mm / 1000
    
    If p_in_atma > p_out_atma And p_out_atma >= 1 Then
        Call choke.calc_choke_calibration(p_in_atma, p_out_atma, tchoke_C)
        out = choke.c_calibr_fr
        out_desc = "c_calibr_fr"
    End If
    MF_calibr_choke_fr = Array(Array(out, p_in_atma, p_out_atma, tchoke_C, choke.c_calibr_fr), _
                         Array(out_desc, "p_intake_atma", "p_out_atma", "Tchoke_C", "c_calibr_fr"))  ' на выходе выдаем массив
    Exit Function
err1:
    MF_calibr_choke_fr = -1
    addLogMsg "Error:MF_calibr_choke_fr:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
 ' функция расчета дебита жидкости через штуцер
 ' при заданном входном и выходном давлениях
Public Function MF_qliq_choke_sm3day( _
        ByVal fw_perc As Double, _
        ByVal dchoke_mm As Double, _
        ByVal p_in_atma As Double, _
        ByVal p_out_atma As Double, _
        Optional ByVal d_pipe_mm As Double = 70, _
        Optional ByVal tchoke_C = 20, _
        Optional ByVal c_calibr_fr As Double = 1, _
        Optional ByVal str_PVT As String = PVT_DEFAULT)
' fw_perc      - обводненность
' dchoke_mm    - диаметр штуцера (эффективный)
' p_in_atma     - давление на входе (высокой стороне)
' p_out_atma    - давление на выходе (низкой стороне)
' опциональные аргументы функции
' d_pipe_mm      - диаметр трубы до и после штуцера
' Tchoke_C      - температура, С.
' c_calibr_fr       - поправочный коэффициент на штуцер
'                 1 - отсутсвие поправки (по умолчанию)
'                 Q_choke_real = c_calibr_fr * Q_choke_model
' str_PVT        - закодированная строка с параметрами PVT.
'                 если задана - перекрывает другие значения
'description_end
On Error GoTo err1:
    Dim choke As New Cchoke
    Dim PVT As CPVT
    Dim Qliq As Double
    
    Set PVT = PVT_decode_string(str_PVT)
    Set choke.fluid = PVT
    choke.Ddown_m = d_pipe_mm / 1000
    choke.Dup_m = d_pipe_mm / 1000
    choke.Dchoke_m = dchoke_mm / 1000
    choke.fluid.fw_perc = fw_perc
    choke.c_calibr_fr = c_calibr_fr
    Qliq = choke.choke_liquid_rate(p_in_atma, p_out_atma, tchoke_C)
    
    MF_qliq_choke_sm3day = Array(Array(Qliq, p_in_atma, p_out_atma, tchoke_C, c_calibr_fr), _
                           Array("Qliq", "p_intake_atma", "p_out_atma", "Tchoke_C", "c_calibr_fr"))
    Exit Function
err1:
    MF_qliq_choke_sm3day = -1
    addLogMsg "Error:MF_qliq_choke_sm3day:" & Err.Description
End Function
' ==============  функции для расчета пласта ==========================
' =====================================================================
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет дебита по давлению и продуктивности
Public Function IPR_qliq_sm3day( _
        ByVal pi_sm3dayatm As Double, _
        ByVal Pres_atma As Double, _
        ByVal pwf_atma As Double, _
        Optional ByVal fw_perc As Double = 0, _
        Optional ByVal pb_atma As Double = -1)
'
' pi_sm3dayatm   - коэффициент продуктивности
' Pres_atma        - пластовое давление, атм
' pwf_atma       - забойное давление
'
' необязательные параметры
' fw_perc      - обводненность
' pb_atma        - давление насыщения
'description_end
On Error GoTo err1:
    Dim res As New CReservoirVogel
    If pb_atma <= 0 Then pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pres_atma, pb_atma, fw_perc
    res.pi_sm3dayatm = pi_sm3dayatm
    
    IPR_qliq_sm3day = res.calc_qliq_sm3day(pwf_atma)
    Set res = Nothing
    
    
    Exit Function
err1:
    IPR_qliq_sm3day = -1
    addLogMsg "Error:IPR_qliq_sm3day:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет забойного давления по дебиту и продуктивности
Public Function IPR_pwf_atma( _
        ByVal pi_sm3dayatm As Double, _
        ByVal Pres_atma As Double, _
        ByVal qliq_sm3day As Double, _
        Optional ByVal fw_perc As Double = 0, _
        Optional ByVal pb_atma As Double = -1)
' pi_sm3dayatm   - коэффициент продуктивности
' Pres_atma      - пластовое давление, атм
' qliq_sm3day    - дебит жидкости скважины на поверхности
' необязательные параметры
' fw_perc        - обводненность
' pb_atma        - давление насыщения
'description_end
On Error GoTo err1:
    Dim res As New CReservoirVogel
    If pb_atma <= 0 Then pb_atma = 0   ' поставим ноль иначе флюид подсчитает по корреляции значение
    res.InitProp Pres_atma, pb_atma, fw_perc
    res.pi_sm3dayatm = pi_sm3dayatm
    IPR_pwf_atma = res.calc_pwf_atma(qliq_sm3day)
    Set res = Nothing
    
    Exit Function
err1:
    IPR_pwf_atma = -1
    addLogMsg "Error:IPR_pwf_atma:" & Err.Description
End Function
'description_to_manual      - для автогенерации описания - помещает заголовок функции и окружающие комментарии в мануал (со след строки)
' расчет коэффициента продуктивности пласта
' по данным тестовой эксплуатации
Public Function IPR_pi_sm3dayatm( _
        ByVal Qtest_sm3day As Double, _
        ByVal Pwftest_atma As Double, _
        ByVal Pres_atma As Double, _
        Optional ByVal fw_perc As Double = 0, _
        Optional ByVal pb_atma As Double = -1)
' Qtest_sm3day   - тестовый дебит скважины
' Pwftest_atma   - тестовое забойное давление
' Pres_atma      - пластовое давление, атм
' необязательные параметры
' fw_perc        - обводненность
' pb_atma        - давление насыщения
'description_end
On Error GoTo err1:
    Dim res As New CReservoirVogel
    If pb_atma <= 0 Then pb_atma = 0   ' поставим ноль иначе флюид подсчитает по корреляции значение
    res.InitProp Pres_atma, pb_atma, fw_perc
    IPR_pi_sm3dayatm = res.calc_pi_sm3dayatm(Qtest_sm3day, Pwftest_atma)
    Set res = Nothing
    
    Exit Function
err1:
    IPR_pi_sm3dayatm = -1
    addLogMsg "error in function :IPR_pi_sm3dayatm:" & Err.Description
End Function
' функция вывода номера версии унифлок для расчетных модулей
Public Function getUFVersion()
    getUFVersion = const_unifloc_version
End Function
' вспомогательная функция для создания PVT объекта из исходных данных
Private Function readPVT(Optional ByVal gamma_gas As Double = const_gg_, _
                    Optional ByVal gamma_oil As Double = const_go_, _
                    Optional ByVal gamma_wat As Double = const_gw_, _
                    Optional ByVal rsb_m3m3 = const_rsb_default, _
                    Optional ByVal rp_m3m3 = -1, _
                    Optional ByVal pb_atma = -1, _
                    Optional ByVal tres_C = const_tres_default, _
                    Optional ByVal bob_m3m3 = -1, _
                    Optional ByVal muob_cP = -1, _
                    Optional ByVal PVTcorr = Standing_based, _
                    Optional ByVal ksep_fr = 0, _
                    Optional ByVal pksep_atma = -1, _
                    Optional ByVal tksep_C = -1, _
                    Optional ByVal str_PVT As String = "" _
                    ) As CPVT
    Dim PVT As CPVT
    If str_PVT <> "" Then
        Set PVT = PVT_decode_string(str_PVT)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, pb_atma, bob_m3m3, PVTcorr, tres_C, rp_m3m3, muob_cP
        If ksep_fr > 0 And ksep_fr <= 1 And pksep_atma > 0 And tksep_C > 0 Then
            Call PVT.mod_after_separation(pksep_atma, tksep_C, ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Set readPVT = PVT
End Function
Private Function ArrayOut(pt As PTtype)
    ArrayOut = Array(pt.p_atma, pt.t_c)
End Function
